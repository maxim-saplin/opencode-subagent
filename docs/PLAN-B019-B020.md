# Implementation Plan: B-019 & B-020

Date: 2026-02-11

## Overview

Two tightly coupled features that extend model metadata tracking and display:

- **B-019** — Pass `--variant` (reasoning effort) through the CLI to opencode
- **B-020** — Improve the `status --diagram` table: add MODEL column, rename DIALOG → DIALOG_TKN

B-019 should be implemented first because B-020's MODEL column should display variant info when present.

> **Note:** `status_watch` / `status --diagram` is a user-facing display script only. It reads from the registry but has no effect on agent functioning. All changes in B-020 are purely presentational.

---

## B-019: Model variant pass-through

### Discovery

The real `opencode` binary already supports `--variant`:

```
--variant  model variant (provider-specific reasoning effort, e.g., high, max, minimal)  [string]
```

The opencode-subagent CLI currently has no awareness of this flag. Implementation is a pure pass-through: parse it, store it, forward it to the spawned `opencode run` process.

### Changes

#### 1. CLI arg parsing — `runCommand()` (~L945)

Add `--variant` case next to `--model`:

```js
case "--variant":
  variant = argv[i + 1] || "";
  i += 1;
  break;
```

Initialize `let variant = "";` alongside the existing `let model = "";`.

Resolve with env fallback:

```js
const variantValue = variant || process.env.OPENCODE_PSA_VARIANT || "";
```

#### 2. Scheduled record (~L998)

Add `variant: variantValue` to `scheduledRecord`.

#### 3. Worker payload (~L1024)

Add `variant: variantValue` to payload object.

#### 4. Output JSON (~L1043)

Add `variant: variantValue || null` to `printJson()` call.

#### 5. `runWorker()` — spawn args (~L1082)

Extract variant from payload:

```js
const variant = payload.variant || "";
```

Conditionally add to spawn args:

```js
if (variant) args.push("--variant", variant);
```

#### 6. `runWorker()` — registry records (~L1110, ~L1148)

Add `variant` to `runningRecord` and `doneRecord`.

#### 7. Environment variable

New env var: `OPENCODE_PSA_VARIANT` — optional, no default.

#### 8. `resume_subagent` path

The resume flow reuses the same `runCommand()`. When resuming, variant should be accepted but is optional (empty means "keep whatever opencode defaults to"). No special resume-specific handling needed — it flows through the same spawn path.

### Tests

| Test file | Change |
|-----------|--------|
| `tests/non-llm/run_subagent.basic.spec.ts` | Add test: `--variant high` appears in spawned args; verify output JSON contains `variant` |
| `tests/non-llm/run_subagent.spec.ts` | Add test: variant stored in registry record |
| `tests/mock-opencode/opencode` | Accept `--variant` in `parseRunArgs()`, return it in model info |

**Mock changes**: In `parseRunArgs()` add:

```js
} else if (a === "--variant") {
  variant = runArgs[++i] || "";
```

And return variant in the parsed result. Optionally include variant in the export `info.model` object.

### Docs

| File | Change |
|------|--------|
| SKILL.md | Add `[--variant <variant>]` to `start_subagent.sh` usage, flags table, env vars table |
| SKILL.md | Add `variant` to success output JSON example |
| SKILL.md | Add `--variant <variant>` to the flags list with description: "Model variant / reasoning effort (e.g., high, low, minimal). Falls back to `OPENCODE_PSA_VARIANT`." |

---

## B-020: Improve status_watch table

> `status_watch` is a user-facing display script. It reads registry data but does not affect agent lifecycle or behavior. All changes here are purely presentational.

### Current state

The `renderDiagram()` function (L740) builds two tables (LIVE AGENTS, DONE AGENTS) with columns:

```
NAME  STATUS  PID  STARTED  [COMPLETED]  RUNTIME  MSG  DIALOG  FULL
```

The `model` field exists on every registry record (e.g. `"opencode/gpt-5-nano"`) but is not displayed in the diagram.

### Changes

#### 1. Add MODEL column — `renderDiagram()` (~L756, ~L780)

Add `model` to both `liveRows` and `doneRows` map functions. Keep the full `provider/model` string — do **not** strip the provider prefix. Append variant with a dash separator:

```js
const modelBase = agent.model || "-";
const variantSuffix = agent.variant ? `-${agent.variant}` : "";
model: modelBase !== "-" ? modelBase + variantSuffix : "-",
```

Add column definition to both tables, positioned after STATUS:

```js
{ header: "MODEL", key: "model" },
```

This yields display values like `opencode/gpt-5-nano` or `opencode/gpt-5-nano-high`.

#### 2. Rename DIALOG → DIALOG_TKN

In both column arrays, change:

```js
{ header: "DIALOG", key: "dialogTokens", align: "right" }
```

to:

```js
{ header: "DIALOG_TKN", key: "dialogTokens", align: "right" }
```

#### 3. `sanitizeAgentForStatus()` (~L308)

Add `model` and `variant` to the sanitized output so JSON consumers also receive it:

```js
if (record.model !== undefined) out.model = record.model;
if (record.variant !== undefined) out.variant = record.variant;
```

#### 4. Expected result

```
LIVE AGENTS
NAME            STATUS   MODEL                       PID  STARTED              RUNTIME  MSG  DIALOG_TKN  FULL
pipeline/build  running  opencode/gpt-5-nano-high  34812  2026-02-10 15:31:40  00:02:48    -           -     -

DONE AGENTS
NAME            STATUS  MODEL               PID  STARTED              COMPLETED             RUNTIME  MSG  DIALOG_TKN  FULL
pipeline/plan   done    opencode/gpt-5-nano  31287  2026-02-10 15:29:51  2026-02-10 15:31:15  00:01:24    2       10396     -
```

### Tests

| Test file | Change |
|-----------|--------|
| `tests/non-llm/status.daemon.spec.ts` L235 | Change `expect(output).toContain("DIALOG")` → `expect(output).toContain("DIALOG_TKN")` |
| `tests/non-llm/status.daemon.spec.ts` L235 | Add `expect(output).toContain("MODEL")` |
| `tests/non-llm/status.daemon.spec.ts` | Add test: verify MODEL column shows full `opencode/gpt-5-nano` from registry |
| `tests/non-llm/status.daemon.spec.ts` | Add test: verify MODEL column appends variant with dash (e.g. `opencode/gpt-5-nano-high`) when variant is set |

### Docs

| File | Change |
|------|--------|
| SKILL.md | Update status `--diagram` section if one exists; otherwise note MODEL column in status description |

---

## Implementation order

```
Step 1  B-019  Parse --variant in runCommand()            (~15 min)
Step 2  B-019  Add variant to payload, records, spawn     (~15 min)
Step 3  B-019  Add OPENCODE_PSA_VARIANT env fallback      (~5 min)
Step 4  B-019  Update mock-opencode to accept --variant   (~10 min)
Step 5  B-019  Add/update tests                           (~20 min)
Step 6  B-019  Update SKILL.md                            (~10 min)
Step 7  B-020  Add MODEL column to renderDiagram()        (~15 min)
Step 8  B-020  Rename DIALOG → DIALOG_TKN                 (~5 min)
Step 9  B-020  Add model/variant to sanitizeAgentForStatus (~5 min)
Step 10 B-020  Update diagram test assertions             (~10 min)
Step 11 Both   Run full test suite, fix regressions       (~15 min)
Step 12 Both   Update BACKLOG.md, CHANGELOG               (~5 min)
```

## Files touched (summary)

| File | B-019 | B-020 |
|------|:-----:|:-----:|
| `.claude/skills/opencode-subagent/bin/opencode-subagent.js` | X | X |
| `.claude/skills/opencode-subagent/SKILL.md` | X | X |
| `tests/mock-opencode/opencode` | X | |
| `tests/non-llm/run_subagent.basic.spec.ts` | X | |
| `tests/non-llm/run_subagent.spec.ts` | X | |
| `tests/non-llm/status.daemon.spec.ts` | | X |
| `docs/BACKLOG.md` | X | X |
| `docs/CHANGELOG.md` | X | X |

## Risks

- **Variant in export data**: The opencode `export` JSON may or may not include variant info per message. If it does, the daemon could auto-detect variant from export data (useful for sessions started outside our CLI). This is a nice-to-have enhancement, not a blocker.
- **Column width**: Adding MODEL increases table width. For terminal widths < ~140 columns, the table may wrap. Acceptable since `status --diagram` is a monitoring tool typically used in wide terminals.
